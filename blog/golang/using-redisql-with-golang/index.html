<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Using RediSQL with Go(lang) - zeeSQL</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-116709819-1', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../..">zeeSQL</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../..">Overview</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../tutorial/">Tutorial</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../../references/">References</a>
                    </li>
                    <li >
                        <a href="../../../pro/">Pro</a>
                    </li>
                    <li >
                        <a href="../../../motivations/">Motivations</a>
                    </li>
                    <li >
                        <a href="../../../pricing/">Pricing</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Blog <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../release_0.9.0/">Release 0.9.0</a>
</li>
                            
<li >
    <a href="../../release_0.8.0/">Release 0.8.0</a>
</li>
                            
<li >
    <a href="../../release_0.7.0/">Release 0.7.0</a>
</li>
                            
<li >
    <a href="../../release_0.6.0/">Release 0.6.0</a>
</li>
                            
<li >
    <a href="../../release_0.5.0/">Release 0.5.0</a>
</li>
                            
<li >
    <a href="../../analytics/">Analytics</a>
</li>
                            
<li >
    <a href="../../JaaS/">JSON on Redis using RediSQL, SQL steroids for Redis</a>
</li>
                            
<li >
    <a href="../../performances/">Double performances of RediSQL going zero copy</a>
</li>
                            
<li >
    <a href="../../python/using-redisql-with-python/">Using RediSQL with Python</a>
</li>
                            
<li class="active">
    <a href="./">Using RediSQL with Go(lang)</a>
</li>
                            
<li >
    <a href="../../node/using-redisql-with-node/">Using RediSQL with Node.js</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../../faqs/">FAQs</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../../python/using-redisql-with-python/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../node/using-redisql-with-node/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/RedBeardLab/zeeSQL-doc">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#using-redisql-with-golang">Using RediSQL with Go(lang)</a></li>
            <li><a href="#creating-a-redis-pooled-connection">Creating a Redis Pooled Connection</a></li>
            <li><a href="#setting-up-the-database">Setting up the database</a></li>
            <li><a href="#the-loop">The loop</a></li>
            <li><a href="#concluding">Concluding</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="using-redisql-with-golang">Using RediSQL with Go(lang)</h1>
<p>This tutorial will help you to get start to use RediSQL with Go(lang).</p>
<p>In this tutorial we will scrape the content of Hacker News using their <a href="https://github.com/HackerNews/API">API documented here</a>.</p>
<p>To communicate with Redis we will use the popular <a href="https://github.com/mediocregopher/radix">radix</a> library wich is the most suitable to communicate with Redis Modules and RediSQL. Other libraries can be used as well, but some more work will be necessary.</p>
<p>To follow this tutorial you will need a modern (&gt; v4.0) instance of Redis running RediSQL.
You can obtain RediSQL from <a href="https://payhip.com/b/Ri4d">our shop</a> or from the <a href="https://github.com/RedBeardLab/rediSQL/releases">github releases</a>.</p>
<p>To load RediSQL is sufficient to pass it as argument to the redis-server: <code>./redis-server --loadmodule /path/to/redisql.so</code></p>
<p>The whole code show in this example is reachable <a href="https://github.com/RedBeardLab/rediSQL/blob/master/doc/docs/blog/golang/main.go">here</a></p>
<h2 id="creating-a-redis-pooled-connection">Creating a Redis Pooled Connection</h2>
<p>Using <code>radix</code> is quite simple to use a pooled connection to Redis, indeed <code>radix</code> provide the <code>NewPool</code> function that creates a pool of connection to Redis. Then it is possible to use that pool as a client and have the library allocate a client for us.</p>
<pre><code class="golang">redis, err := radix.NewPool(&quot;tcp&quot;, &quot;localhost:6379&quot;, 10)
if err != nil {
    fmt.Println(err)
        return
}
</code></pre>

<h2 id="setting-up-the-database">Setting up the database</h2>
<p>In order to work with RediSQL is necessary to do a small setup. 
The first step is always to create a database, then we create the tables inside the databases and finally the different statements if they are necessary.</p>
<p>It is always a good idea to use statements instead of building query by hand, but it is not mandatory. 
The use of statements eliminate the risk of SQL injection and it is more performant, since the query is parsed only once and not every time it get executed.</p>
<p>In our case we create a simple database that we will call <code>HN</code>.</p>
<pre><code class="golang">r.Do(radix.Cmd(nil, &quot;REDISQL.CREATE_DB&quot;, &quot;HN&quot;))
</code></pre>

<p>Then we create a single table <code>hn</code> inside the <code>HN</code> database.</p>
<pre><code class="golang">table := &quot;CREATE TABLE IF NOT EXISTS hn(id integer primary key, author text, time int, item text);&quot;
r.Do(radix.Cmd(nil, &quot;REDISQL.EXEC&quot;, &quot;HN&quot;, table))
</code></pre>

<p>The table will contains the <code>id</code> of each item we are getting from HN, along with the author of the item, when the item was posted and finally the last field will contains the whole item as a <code>json</code> string.</p>
<p>The last step is to create a statement to easily insert the data inside our table.</p>
<pre><code class="golang">stmt := `INSERT INTO hn VALUES(
    json_extract(json(?1),'$.id'), 
    json_extract(json(?1),'$.by'), 
    json_extract(json(?1),'$.time'), 
    json(?1));`
r.Do(radix.Cmd(nil, &quot;REDISQL.CREATE_STATEMENT&quot;, &quot;HN&quot;, &quot;insert_item&quot;, stmt))
</code></pre>

<p>The statement is a little complex. 
It exploit the <a href="https://www.sqlite.org/json1.html">JSON1</a> sqlite extension to extract the necessary fields from a JSON string. 
In particular we extract the <code>id</code>, the <code>by</code> (author) and the <code>time</code> fields.</p>
<p>After that those fields are extracted from the JSON string we store all of them into the database along with the whole item.</p>
<h2 id="the-loop">The loop</h2>
<p>After the database is ready to accept data, we start to poll the HN API in order to fetch the newest item. 
Each item is then pushed into the <code>itemIds</code> channel that is later consumed.</p>
<pre><code class="golang">itemIds := make(chan int, 10)

go func() {
    oldMaxItemId := getMaxItem()
    for {
        newMaxItemId := getMaxItem()
        for ; oldMaxItemId &lt; newMaxItemId; oldMaxItemId++ {
            itemIds &lt;- oldMaxItemId
        }
        time.Sleep(5 * time.Second)
    }
}()
</code></pre>

<p>The API provide an endpoint that show the biggest element in HN at the moment, it is a simple auto-incremental id that we can fetch using the <code>getMaxItem()</code> function implemented as:</p>
<pre><code class="golang">func getMaxItem() int {
    resp, _ := http.Get(&quot;https://hacker-news.firebaseio.com/v0/maxitem.json&quot;)
    defer resp.Body.Close()
    body, _ := ioutil.ReadAll(resp.Body)
    n, _ := strconv.Atoi(string(body))
    return n
}
</code></pre>

<p>Finally the main loop iterate through the <code>itemIds</code> channel.
For each new item we use again the HN API to get the content of the items and then we store it into RediSQL.</p>
<pre><code class="golang">for itemId := range itemIds {
    go func() {
        item := getItem(itemId)
        err := redis.Do(radix.Cmd(nil, &quot;REDISQL.EXEC_STATEMENT&quot;, &quot;HN&quot;, &quot;insert_item&quot;, item))
        if err != nil {
            fmt.Println(err)
        }
    }()
}
</code></pre>

<p>The <code>getitem()</code> functions implement a trivial error recovery strategy. 
Indeed, after some trial and error, was clear that, sometimes, the element <code>n</code> is not ready yet even if the element <code>n+1</code> was published as <code>maxitem</code> and the API returns the simple string "null", if that is the case we simply repeat the call.</p>
<pre><code class="golang">func getItem(id int) string {
    for {
        url := fmt.Sprintf(&quot;https://hacker-news.firebaseio.com/v0/item/%d.json&quot;, id)
        resp, _ := http.Get(url)
        defer resp.Body.Close()
        body, _ := ioutil.ReadAll(resp.Body)
        result := string(body)
        if result != &quot;null&quot; {
            return result
        }
    }
}

</code></pre>

<h2 id="concluding">Concluding</h2>
<p>This small example (less than 80 lines) show how simple is to quickly get value from RediSQL.
Indeed is sufficient to set up the database following always the same steps:</p>
<ol>
<li>Create the database with <code>REDISQL.CREATE_DB $db_name</code></li>
<li>Create the schema inside your database <code>REDISQL.EXEC $db_name "CREATE TABLE ... etc"</code> and, if you want, the statements: <code>REDISSQL.CREATE_STATEMENT $db_name $statement_name "INSERT INTO ... etc"</code></li>
<li>Start inserting data, with or without a statement: <code>REDISQL.EXEC_STATEMENT</code> or simply <code>REDISQL.EXEC</code></li>
</ol>
<p>Finally to query back the data is possible to use:</p>
<ul>
<li>queries <code>REDISQL.QUERY $db_name "SELECT * FROM ..."</code>,</li>
<li>statements <code>REDISQL.CREATE_STATEMENT $db_name $query_name "SELECT * FROM ... WHERE foo = ?1"</code> and the <code>REDISQL.QUERY_STATEMENTS $db_name $query_name "paramenters"</code></li>
<li>simple exec <code>REDISQL.EXEC $db_name "SELECT * FROM ... etc"</code></li>
</ul>
<p>Feel free to explore our <a href="../../../references">references documentation</a> to understand better what capabilities RediSQL provides you.</p>
<p>The complete code of this example is <a href="https://github.com/RedBeardLab/rediSQL/blob/master/doc/docs/blog/golang/main.go">available here.</a></p>
<p>If you wish to see a similar tutorial for a different language, <a href="https://github.com/RedBeardLab/rediSQL/issues/new">open an issue on github.</a></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../blog/node/hn.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
